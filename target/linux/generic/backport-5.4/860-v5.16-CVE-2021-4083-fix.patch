Index: linux-5.4.147/fs/file.c
===================================================================
--- linux-5.4.147.orig/fs/file.c
+++ linux-5.4.147/fs/file.c
@@ -723,6 +723,10 @@ loop:
 			file = NULL;
 		else if (!get_file_rcu_many(file, refs))
 			goto loop;
+		else if (__fcheck_files(files, fd) != file) {
+			fput_many(file, refs);
+			goto loop;
+		}
 	}
 	rcu_read_unlock();
 
